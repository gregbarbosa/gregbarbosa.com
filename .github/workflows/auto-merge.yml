name: Auto Merge Content PR

on:
  pull_request:
    types: [opened, synchronize, labeled]
  check_suite:
    types: [completed]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    if: github.event.pull_request.auto_merge != null || github.event_name == 'pull_request'

    steps:
      - name: Check if content-only PR
        id: content-check
        run: |
          git fetch origin main --depth=1
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.ref }} ${{ github.event.pull_request.head.ref }} | grep -v '^src/components\|^src/layouts\|^src/pages\|^astro.config\|^.gitignore\|package.json\|package-lock.json\|tsconfig.json\|tailwind.config\|eslint\|.github/workflows\|public/_headers' || true)
          if [ -n "$CHANGED_FILES" ]; then
            echo "content_only=true" >> $GITHUB_OUTPUT
          else
            echo "content_only=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if all required checks passed
        id: checks-passed
        run: |
          gh pr checks ${{ github.event.pull_request.number }} --json conclusion --jq '.[].conclusion' | grep -q "SUCCESS"
          if [ $? -eq 0 ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Enable auto-merge
        if: steps.content-check.outputs.content_only == 'true' && steps.checks-passed.outputs.passed == 'true'
        run: |
          gh pr merge ${{ github.event.pull_request.number }} --auto --squash --body "Auto-merged content update from Obsidian vault."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on failed checks
        if: steps.content-check.outputs.content_only == 'true' && steps.checks-passed.outputs.passed == 'false'
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "⚠️ Auto-merge skipped: Some checks failed. Please review before merging."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
