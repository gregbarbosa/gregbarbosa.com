name: Auto Content PR

on:
  push:
    branches-ignore:
      - main

jobs:
  check-and-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check changed files
        id: files
        run: |
          git fetch origin main --depth=1
          CHANGED_FILES=$(git diff --name-only HEAD origin/main | grep -v '^src/components\|^src/layouts\|^src/pages\|^astro.config\|^.gitignore\|package.json\|package-lock.json\|tsconfig.json\|tailwind.config\|eslint\|.github/workflows\|public/_headers' || true)
          {
            echo "changed<<EOF"
            echo "$CHANGED_FILES"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          if [ -n "$CHANGED_FILES" ]; then
            echo "content_only=true" >> $GITHUB_OUTPUT
          else
            echo "content_only=false" >> $GITHUB_OUTPUT
          fi

      - name: Create PR for content changes
        if: steps.files.outputs.content_only == 'true'
        run: |
          gh pr create \
            --title "Content update: $(git log -1 --oneline --format='%s')" \
            --body "Auto-generated PR for content changes from Obsidian vault." \
            --base main \
            --head ${{ github.ref_name }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge for content PRs
        if: steps.files.outputs.content_only == 'true'
        run: |
          PR_NUMBER=$(gh pr list --base main --head ${{ github.ref_name }} --json number -q '.[0].number')
          gh pr merge $PR_NUMBER --auto --squash --body "Auto-merged content update."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Comment on non-content changes
        if: steps.files.outputs.content_only == 'false'
        run: |
          PR_NUMBER=$(gh pr list --base main --head ${{ github.ref_name }} --json number -q '.[0].number' || echo "")
          if [ -n "$PR_NUMBER" ]; then
            gh pr comment $PR_NUMBER --body "⚠️ **This PR contains non-content files.** Please review manually before merging."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
